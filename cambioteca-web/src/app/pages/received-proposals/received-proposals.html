<div class="proposals-container">
  <h1>Propuestas Recibidas</h1>
  <p class="subtitle">Aquí están las solicitudes de intercambio que otros usuarios te han enviado.</p>

  <div *ngIf="isLoading" class="message">Cargando propuestas...</div>
  <div *ngIf="error && !isLoading" class="message error">{{ error }}</div>

  <div *ngIf="!isLoading">
    <div *ngIf="recibidas.length === 0 && !error" class="empty-state">
      <p>No tienes propuestas recibidas.</p>
    </div>

    <div *ngIf="recibidas.length > 0" class="proposals-list">
      <div *ngFor="let proposal of recibidas" class="proposal-item">
        
        <div class="item-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor"><path d="M249.6 471.5c10.8 3.8 22.4-4.1 22.4-15.5V78.6c0-4.2-1.6-8.4-5-11C247.4 52 202.4 32 144 32C93.5 32 46.3 45.3 18.1 56.1C6.8 60.5 0 71.7 0 83.8V454.1c0 11.9 12.8 20.2 24.1 16.5C55.6 460.1 105.5 448 144 448c33.9 0 79 14 105.6 23.5zm76.8 0C353 462 398.1 448 432 448c38.5 0 88.4 12.1 119.9 22.6c11.3 3.8 24.1-4.6 24.1-16.5V83.8c0-12.1-6.8-23.3-18.1-27.6C529.7 45.3 482.5 32 432 32c-58.4 0-103.4 20-123 35.6c-3.3 2.6-5 6.8-5 11V456c0 11.4 11.7 19.3 22.4 15.5z"/></svg>
        </div>

        <div class="item-content">
          <h3>Solicitan tu libro: {{ proposal.libro_deseado?.titulo || 'N/A' }}</h3>
          <p class="subtitle">De: {{ getCounterpartyName(proposal) }}</p>
          <div class="meta">
            <span class="status-chip {{ getStatusColor(proposal.estado) }}">{{ proposal.estado }}</span>
            <span class="offer-count" *ngIf="getOfferCount(proposal) > 0">{{ getOfferCount(proposal) }} oferta(s)</span>
            <span class="date">{{ proposal.actualizada_en || proposal.creada_en | date:'short' }}</span>
          </div>
          
          <div *ngIf="proposal.lugar_intercambio && proposal.lugar_intercambio !== 'A coordinar'" class="place-info">
            <ng-container *ngIf="proposal.propuesta_estado === 'ACEPTADA'; else propuesto">
              Lugar acordado: <strong>{{ proposal.lugar_intercambio }}</strong>
            </ng-container>
            <ng-template #propuesto>
              Lugar propuesto: <strong>{{ proposal.lugar_intercambio }}</strong>
            </ng-template>
            <br>
            <small>{{ proposal.fecha_intercambio_pactada | date:'short' }}</small>
          </div>
        </div>
        
        <div class="item-actions">
          
          <ng-container *ngIf="isPending(proposal)">
            <button *ngIf="canAcceptSingleOffer(proposal)" class="btn btn-accept" (click)="acceptSingleOffer(proposal)" [disabled]="isProcessingAction">
              Aceptar
            </button>
            <button class="btn btn-view-details" (click)="goToDetail(proposal.id_solicitud)">
              {{ canAcceptSingleOffer(proposal) ? 'Ver Detalle' : 'Ver y Elegir Oferta' }}
            </button>
            <button class="btn btn-reject" (click)="reject(proposal)" [disabled]="isProcessingAction">
              Rechazar
            </button>
          </ng-container>
          
          <ng-container *ngIf="proposal.estado === 'Aceptada'">
            
            <button 
              *ngIf="proposal.propuesta_estado !== 'ACEPTADA'" 
              class="btn btn-propose" 
              (click)="openProposePlaceModal(proposal)">
              {{ (proposal.lugar_intercambio && proposal.lugar_intercambio !== 'A coordinar') ? 'Modificar Lugar' : 'Proponer Lugar' }}
            </button>
            
            <button 
              *ngIf="proposal.propuesta_estado === 'ACEPTADA'" 
              class="btn btn-generate-code" 
              (click)="openGenerateCodeModal(proposal)">
              Generar Código
            </button>

            <a *ngIf="proposal.conversacion_id" [routerLink]="['/chat', proposal.conversacion_id]" class="btn btn-chat">Ir al Chat</a>
          </ng-container>
          <ng-container *ngIf="isCompleted(proposal)">
            <button *ngIf="canRate(proposal)" class="btn btn-rate" (click)="openRatingModal(proposal)">
              Calificar Usuario
            </button>
            <span *ngIf="hasRated(proposal)" class="status-info rated">
              Ya calificado ✔️
            </span>
          </ng-container>

          <span *ngIf="proposal.estado === 'Rechazada' || proposal.estado === 'Cancelada'" class="status-info">
            {{ proposal.estado }}
          </span>
        </div>
        
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showGenerateCodeModal">
  <div class="modal-content generated-code-modal">
    <h3>Código de Confirmación</h3>
    <div *ngIf="isGeneratingCode" class="modal-loading">Generando código...</div>
    <div *ngIf="generatedCodeData && !isGeneratingCode">
      <p>Comparte este código con el otro usuario para completar el intercambio:</p>
      <div class="generated-code">{{ generatedCodeData?.codigo }}</div>
      <p class="expiry-info" *ngIf="generatedCodeData?.expira_en">
        Expira el: {{ generatedCodeData?.expira_en | date:'medium' }}
      </p>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" (click)="closeGeneratedCodeModal()" [disabled]="isGeneratingCode">Cerrar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showRatingModal">
  <div class="modal-content rating-modal">
    <h3>Calificar Intercambio</h3>
    <p>Evalúa tu experiencia con el otro usuario.</p>
    
    <div class="modal-form-group">
      <label>Puntuación (1 a 5 estrellas)</label>
      <div class="rating-stars">
        <span *ngFor="let star of [1, 2, 3, 4, 5]"
              [class.selected]="star <= ratingData.puntuacion"
              (click)="ratingData.puntuacion = star">
          ★
        </span>
      </div>
    </div>

    <div class="modal-form-group">
      <label for="comentario_calificacion">Comentario (Opcional)</label>
      <textarea id="comentario_calificacion" [(ngModel)]="ratingData.comentario" rows="3"></textarea>
    </div>
    
    <div *ngIf="ratingError" class="modal-error">
      {{ ratingError }}
    </div>
    
    <div class="modal-actions">
      <button class="btn btn-secondary" (click)="closeRatingModal()" [disabled]="isSubmittingRating">Cancelar</button>
      <button class="btn btn-rate" (click)="submitRating()" [disabled]="isSubmittingRating">
        {{ isSubmittingRating ? 'Enviando...' : 'Enviar Calificación' }}
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showProposePlaceModal">
  <div class="modal-content propose-place-modal">
    <h3>Proponer Encuentro</h3>
    <p>Sugiere un lugar y fecha para el intercambio. El solicitante deberá confirmarlo.</p>
    <div class="modal-form-group">
      <label for="lugar_encuentro">Lugar de Encuentro</label>
      <input type="text" id="lugar_encuentro" [(ngModel)]="placeData.lugar" placeholder="Ej: Metro Baquedano, salida sur">
    </div>
    <div class="modal-form-group">
      <label for="fecha_encuentro">Fecha y Hora</label>
      <input type="datetime-local" id="fecha_encuentro" [(ngModel)]="placeData.fecha">
    </div>
    <div *ngIf="proposePlaceError" class="modal-error">
      {{ proposePlaceError }}
    </div>
    <div class.modal-actions>
      <button class="btn btn-secondary" (click)="closeProposePlaceModal()" [disabled]="isProposingPlace">Cancelar</button>
      <button class="btn btn-propose" (click)="submitProposePlace()" [disabled]="isProposingPlace || !placeData.lugar || !placeData.fecha">
        {{ isProposingPlace ? 'Proponiendo...' : 'Proponer' }}
      </button>
    </div>
  </div>
</div>

<app-notification
  *ngIf="notificationMessage"
  [message]="notificationMessage"
  [type]="notificationType"
  (close)="clearNotification()">
</app-notification>