<div class="proposals-container">
  <h1>Propuestas Enviadas</h1>
  <p class="subtitle">Solicitudes de intercambio que has enviado a otros usuarios.</p>

  <div *ngIf="isLoading" class="message">Cargando propuestas...</div>
  <div *ngIf="error && !isLoading" class="message error">{{ error }}</div>

  <div *ngIf="!isLoading">
    <div *ngIf="enviadas.length === 0 && !error" class="empty-state">
      <p>No has enviado ninguna propuesta todavía.</p>
    </div>

    <div *ngIf="enviadas.length > 0" class="proposals-list">
      <div *ngFor="let proposal of enviadas" class="proposal-item">
        
        <div class="item-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor"><path d="M16.1 260.2c-22.6 12.9-20.5 47.3 3.6 57.3L160 376V479.3c0 18.1 14.6 32.7 32.7 32.7c9.7 0 18.9-4.3 25.1-11.8l62-74.3 123.9 51.6c18.9 7.9 40.8-4.5 43.9-24.7l64-416c1.9-12.1-3.4-24.3-13.5-31.2s-23.3-7.5-34-1.4l-448 256zm52.1 25.5L409.7 90.6 190.1 336l1.2 1L68.2 285.7zM403.3 425.4L236.7 355.9 450.8 116.6 403.3 425.4z"/></svg>
        </div>

        <div class="item-content">
          <h3>Solicitaste: {{ proposal.libro_deseado?.titulo || 'N/A' }}</h3>
          <p class="subtitle">Para: {{ getCounterpartyName(proposal) }}</p>
          <div class="meta">
            <span class="status-chip {{ getStatusColor(proposal.estado) }}">{{ proposal.estado }}</span>
            <span class="offer-count" *ngIf="getOfferCount(proposal) > 0">Ofreciste {{ getOfferCount(proposal) }} libro(s)</span>
            <span class="date">{{ proposal.actualizada_en || proposal.creada_en | date:'short' }}</span>
          </div>

          <div *ngIf="proposal.lugar_intercambio && proposal.lugar_intercambio !== 'A coordinar'" class="place-info">
            Lugar propuesto: <strong>{{ proposal.lugar_intercambio }}</strong>
            <br>
            <small>{{ proposal.fecha_intercambio_pactada | date:'short' }}</small>
          </div>
        </div>
        
        <div class="item-actions">
          
          <ng-container *ngIf="isPending(proposal)">
            <button class="btn btn-reject" (click)="cancelProposal(proposal)" [disabled]="isProcessingAction">
              Cancelar Solicitud
            </button>
            <button class="btn btn-view-details" (click)="goToDetail(proposal.id_solicitud)">
              Ver Detalle
            </button>
          </ng-container>
          
          <ng-container *ngIf="proposal.estado === 'Aceptada'">
            
            <span *ngIf="!proposal.lugar_intercambio || proposal.lugar_intercambio === 'A coordinar'" class="status-info waiting">
              Esperando que el dueño proponga lugar...
            </span>

            <ng-container *ngIf="proposal.lugar_intercambio && proposal.lugar_intercambio !== 'A coordinar' && !proposal.lugar_confirmado_localmente">
              <button class="btn btn-accept" (click)="confirmPlace(proposal, true)" [disabled]="isConfirmingPlace[proposal.id_solicitud]">
                Aceptar Lugar
              </button>
              <button class="btn btn-reject" (click)="confirmPlace(proposal, false)" [disabled]="isConfirmingPlace[proposal.id_solicitud]">
                Rechazar Lugar
              </button>
            </ng-container>

            <button *ngIf="proposal.lugar_intercambio && proposal.lugar_intercambio !== 'A coordinar' && proposal.lugar_confirmado_localmente" 
                    class="btn btn-complete" 
                    (click)="openCompleteModal(proposal)">
              Completar (Ingresar Código)
            </button>

            <a *ngIf="proposal.conversacion_id" [routerLink]="['/chat', proposal.conversacion_id]" class="btn btn-chat">Chat</a>
          </ng-container>

          <ng-container *ngIf="isCompleted(proposal)">
            <button *ngIf="canRate(proposal)" class="btn btn-rate" (click)="openRatingModal(proposal)">
              Calificar Usuario
            </button>
            <span *ngIf="hasRated(proposal)" class="status-info rated">
              Calificado ✔️
            </span>
          </ng-container>

          <span *ngIf="proposal.estado === 'Rechazada' || proposal.estado === 'Cancelada'" class="status-info">
            {{ proposal.estado }}
          </span>
        </div>
        
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showCompleteModal">
  <div class="modal-content complete-exchange-modal">
    <h3>Completar Intercambio</h3>
    <p>Ingresa el código que te entregó el otro usuario.</p>
    <div class="modal-form-group">
      <label for="completion_code">Código</label>
      <input type="text" id="completion_code" [(ngModel)]="completionCode" placeholder="ABCDEF" maxlength="12">
      <div *ngIf="completionError" class="modal-error">{{ completionError }}</div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" (click)="closeCompleteModal()" [disabled]="isCompleting">Cancelar</button>
      <button class="btn btn-complete" (click)="submitCompletionCode()" [disabled]="isCompleting || !completionCode">
        {{ isCompleting ? 'Verificando...' : 'Confirmar' }}
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showRatingModal">
  <div class="modal-content rating-modal">
    <h3>Calificar Intercambio</h3>
    <div class="modal-form-group">
      <label>Puntuación</label>
      <div class="rating-stars">
        <span *ngFor="let star of [1, 2, 3, 4, 5]" [class.selected]="star <= ratingData.puntuacion" (click)="ratingData.puntuacion = star">⭐</span>
      </div>
    </div>
    <div class="modal-form-group">
      <label>Comentario</label>
      <textarea [(ngModel)]="ratingData.comentario" rows="3"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" (click)="closeRatingModal()" [disabled]="isSubmittingRating">Cancelar</button>
      <button class="btn btn-rate" (click)="submitRating()" [disabled]="isSubmittingRating">Enviar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showConfirmationModal">
  <div class="modal-content confirmation-modal">
    <h3>{{ confirmationTitle }}</h3>
    <p>{{ confirmationMessage }}</p>
    
    <div class="modal-actions">
      <button class="btn btn-secondary" (click)="handleModalCancel()">
        Cancelar
      </button>
      <button class="btn btn-primary" (click)="handleModalConfirm()">
        Aceptar
      </button>
    </div>
  </div>
</div>
<app-notification
  *ngIf="notificationMessage"
  [message]="notificationMessage"
  [type]="notificationType"
  (close)="clearNotification()">
</app-notification>