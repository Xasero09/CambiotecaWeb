<header class="main-header">
  <div class="header-content">

    <a routerLink="/" class="logo">
      <img src="assets/icon/cambiotecasimple.png" alt="Logo Cambioteca">
      <span>Cambioteca</span>
    </a>

    <ng-container *ngIf="currentUser$ | async as user; else loggedOutMenu">
      
      <!-- MODO ADMIN -->
      <nav class="main-nav admin-mode" *ngIf="user.es_admin">
        <a routerLink="/admin" class="nav-link active-link">
          <i class="fa-solid fa-gauge"></i> Panel Admin
        </a>
        <span class="admin-greeting">
          <i class="fa-solid fa-crown"></i> {{ user.nombre_usuario }}
        </span>
        <button class="btn-logout" (click)="onLogoutClick()">
          <i class="fa-solid fa-right-from-bracket"></i>
        </button>
      </nav>

      <!-- MODO USUARIO NORMAL -->
      <ng-container *ngIf="!user.es_admin">
        
        <!-- 1. CLASE NUEVA 'desktop-nav': Esto se ocultará en móviles -->
        <nav class="main-nav desktop-nav">
          <a routerLink="/catalogo" class="nav-link">Catálogo</a>
          <a routerLink="/puntos-encuentro" class="nav-link">Mapa</a>
          
          <div class="nav-dropdown-container">
            <button class="nav-link dropdown-toggle" (click)="toggleProposalsDropdown($event)">
              <span>Propuestas</span>
              <svg class="chevron" [class.rotated]="isProposalsDropdownOpen" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" fill="currentColor">
                <path d="M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z"/>
              </svg>
            </button>
            
            <div class="dropdown-content" *ngIf="isProposalsDropdownOpen" (click)="$event.stopPropagation()">
              <a routerLink="/propuestas/recibidas" (click)="closeAllDropdowns()">
                <i class="fa-solid fa-inbox"></i> <span>Recibidas</span>
              </a>
              <a routerLink="/propuestas/enviadas" (click)="closeAllDropdowns()">
                <i class="fa-solid fa-paper-plane"></i> <span>Enviadas</span>
              </a>
            </div>
          </div>
          
          <a routerLink="/chat" class="nav-link">Mensajes</a>
        </nav>

        <!-- MENÚ DE USUARIO (Siempre visible) -->
        <div class="user-menu">
          <button class="user-greeting-button" (click)="toggleUserDropdown($event)">
            <span class="user-name-text">¡Hola, {{ user.nombre_usuario }}!</span>
            <svg class="chevron" [class.rotated]="isUserDropdownOpen" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" fill="currentColor">
              <path d="M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z"/>
            </svg>
          </button>

          <div class="dropdown-content user-dropdown-mobile" *ngIf="isUserDropdownOpen" (click)="$event.stopPropagation()">
            
            <!-- 2. SECCIÓN MÓVIL: Solo aparece cuando se oculta el menú principal -->
            <div class="mobile-only-links">
              <div class="dropdown-label">Menú Principal</div>
              
              <a routerLink="/catalogo" (click)="closeAllDropdowns()">
                <i class="fa-solid fa-book-open"></i> <span>Catálogo</span>
              </a>
              <a routerLink="/puntos-encuentro" (click)="closeAllDropdowns()">
                <i class="fa-solid fa-map-location-dot"></i> <span>Mapa</span>
              </a>
              <a routerLink="/chat" (click)="closeAllDropdowns()">
                <i class="fa-solid fa-comments"></i> <span>Mensajes</span>
              </a>
              
              <!-- Submenú de propuestas desglosado -->
              <a routerLink="/propuestas/recibidas" (click)="closeAllDropdowns()">
                <i class="fa-solid fa-inbox"></i> <span>Propuestas Recibidas</span>
              </a>
              <a routerLink="/propuestas/enviadas" (click)="closeAllDropdowns()">
                <i class="fa-solid fa-paper-plane"></i> <span>Propuestas Enviadas</span>
              </a>

              <div class="dropdown-divider"></div>
              <div class="dropdown-label">Mi Cuenta</div>
            </div>
            <!-- FIN SECCIÓN MÓVIL -->

            <a routerLink="/perfil" (click)="closeAllDropdowns()">
              <i class="fa-solid fa-user-circle"></i> <span>Mi Perfil</span>
            </a>
            <a routerLink="/mis-libros" (click)="closeAllDropdowns()">
              <i class="fa-solid fa-book-bookmark"></i> <span>Mis Libros</span>
            </a>
            <a routerLink="/historial" (click)="closeAllDropdowns()">
              <i class="fa-solid fa-clock-rotate-left"></i> <span>Historial</span>
            </a>
            
            <div class="dropdown-divider"></div>
            
            <button class="dropdown-logout" (click)="onLogoutClick()">
              <i class="fa-solid fa-right-from-bracket"></i> <span>Cerrar Sesión</span>
            </button>
          </div>
        </div>

      </ng-container>
    </ng-container>

    <ng-template #loggedOutMenu>
      <nav class="guest-nav">
        <a routerLink="/" class="nav-link home-link">Inicio</a>
        <a routerLink="/catalogo" class="nav-link">Catálogo</a>
        <a routerLink="/puntos-encuentro" class="nav-link">Puntos de Encuentro</a>
        <a routerLink="/login" class="nav-link">Iniciar Sesión</a>
        <a routerLink="/registro" class="btn-register">Registrarse</a>
      </nav>
    </ng-template>

  </div>
</header>